{"version":3,"sources":["../../src/optimize/create-inlining-visitor.js"],"names":["t","createInliningVisitor","props","Attribute","enter","node","parent","inlineNodeVisitor","InterpolationEscaped","Iteration","Condition","key","clonePath","isIdentifier","isMemberExpression","inline","traverse","MemberExpression","path","firstMemberExpression","Identifier","ignore","isObjectKey","isObjectProperty","iteration","findParent","n","type","iterationName","matchedProp","find","prop","name","definition","currentValuePath","indexPath","arrayPath","value","defaultPath","replaceWith","resolved","isBoolean","BooleanLiteral","isString","stringLiteral","isNode","isInterpolationEscapedId","consequent","valueNode","booleanLiteral","wasInserted","insertChildren","matchedPropNode","valuePath","isDefaultTruthy","newIdentifier","identifier","logicalExpression","condition","target","_parent","code","ast","newPath","Program","get","isExpressionStatement","identifierName","position","children","findIndex","child","slice","Array","isArray","interpolationEscapedName"],"mappings":"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","file":"create-inlining-visitor.js","sourcesContent":["/* eslint-disable no-param-reassign, no-underscore-dangle */\nimport * as t from '@babel/types';\nimport babelTraverse from '@babel/traverse';\nimport babelGenerator from '@babel/generator';\nimport { iterationName, interpolationEscapedName } from '../ast';\nimport parser from '../parser';\nimport isTruthy from './is-truthy';\nimport getFirstMemberExpression from '../utils/get-first-member-expression';\n\nfunction createInliningVisitor(props) {\n  return {\n    Attribute: {\n      enter(node, parent) {\n        inlineNodeVisitor(node, parent, props, 'valuePath');\n      }\n    },\n    InterpolationEscaped: {\n      enter(node, parent) {\n        inlineNodeVisitor(node, parent, props, 'valuePath');\n      }\n    },\n    Iteration: {\n      enter(node, parent) {\n        inlineNodeVisitor(node, parent, props, 'iterablePath');\n      }\n    },\n    Condition: {\n      enter(node, parent) {\n        inlineNodeVisitor(node, parent, props, 'testPath');\n      }\n    }\n  };\n}\n\nexport default createInliningVisitor;\n\nfunction inlineNodeVisitor(node, parent, props, key) {\n  if (!node[key]) {\n    return;\n  }\n  node[key] = clonePath(node[key].node);\n  if (t.isIdentifier(node[key].node) && !t.isMemberExpression(node[key].parent)) {\n    inline(props, node[key], parent, node);\n    return;\n  }\n  node[key].traverse({\n    MemberExpression(path) {\n      if (t.isMemberExpression(path.parent)) {\n        return;\n      }\n      const firstMemberExpression = getFirstMemberExpression(path);\n      if (!t.isIdentifier(firstMemberExpression)) {\n        return;\n      }\n      inline(props, firstMemberExpression, parent, node);\n    },\n    Identifier(path) {\n      if (path.node.ignore) {\n        return;\n      }\n      const isObjectKey = t.isObjectProperty(path.parent) && path.parent.key === path.node;\n      if (t.isMemberExpression(path.parent) || isObjectKey) {\n        return;\n      }\n      inline(props, path, parent, node);\n    }\n  });\n}\n\nfunction inline(props, path, parent, node) {\n  const iteration = findParent(parent, n => n.type === iterationName);\n  const matchedProp = props.find(prop => prop.name === path.node.name);\n  const definition = matchedProp && matchedProp.definition;\n  if (\n    iteration &&\n    (iteration.currentValuePath.node.name === path.node.name ||\n      (iteration.indexPath && iteration.indexPath.node.name === path.node.name) ||\n      (iteration.arrayPath && iteration.arrayPath.node.name === path.node.name))\n  ) {\n    return;\n  }\n  if (!matchedProp || !matchedProp.value) {\n    if (definition && definition.defaultPath) {\n      path.replaceWith(definition.defaultPath.node);\n      return;\n    }\n    if (!node.resolved) {\n      path.node.name = 'undefined';\n    }\n    return;\n  }\n  if (matchedProp.value.isBoolean) {\n    path.replaceWith(t.BooleanLiteral(true));\n    return;\n  }\n  if (matchedProp.value.isString) {\n    path.replaceWith(t.stringLiteral(matchedProp.value.value));\n    return;\n  }\n  if (matchedProp.value.isNode) {\n    if (isInterpolationEscapedId(matchedProp.name, node.consequent)) {\n      node.consequent = matchedProp.value.valueNode;\n      path.replaceWith(t.booleanLiteral(true));\n      return;\n    }\n    const wasInserted = insertChildren(parent, matchedProp.name, matchedProp.value.valueNode);\n    if (wasInserted) {\n      return;\n    }\n    path.replaceWith(t.booleanLiteral(true));\n    return;\n  }\n  if (matchedProp.name === 'children') {\n    insertChildren(parent, 'children', matchedProp.value);\n    return;\n  }\n  const matchedPropNode = matchedProp.value.valuePath.node;\n  const isDefaultTruthy = definition && definition.defaultPath && isTruthy(definition.defaultPath);\n  if (t.isIdentifier(matchedPropNode)) {\n    if (definition && definition.defaultPath && isDefaultTruthy) {\n      const newIdentifier = t.identifier(matchedPropNode.name);\n      newIdentifier.ignore = true;\n      path.replaceWith(t.logicalExpression('||', newIdentifier, definition.defaultPath.node));\n      node.resolved = true;\n      return;\n    }\n    path.node.name = matchedPropNode.name;\n    node.resolved = true;\n    return;\n  }\n  path.replaceWith(matchedPropNode);\n  node.resolved = true;\n}\n\nfunction findParent(node, condition) {\n  let target = node;\n  while (target._parent) {\n    if (condition(target)) {\n      return target;\n    }\n    target = target._parent;\n  }\n  return null;\n}\n\nfunction clonePath(node) {\n  const code = babelGenerator(node).code;\n  const ast = parser(code);\n  let newPath = null;\n  babelTraverse(\n    ast,\n    {\n      Program(path) {\n        newPath = path.get('body.0');\n        if (t.isExpressionStatement(newPath.node)) {\n          newPath = newPath.get('expression');\n        }\n      }\n    },\n    null\n  );\n  return newPath;\n}\n\nfunction insertChildren(parent, identifierName, node) {\n  const position = parent.children.findIndex(child =>\n    isInterpolationEscapedId(identifierName, child)\n  );\n  if (position === -1) {\n    return false;\n  }\n  parent.children = [\n    ...parent.children.slice(0, position),\n    ...(Array.isArray(node) ? node : [node]),\n    ...parent.children.slice(position + 1)\n  ];\n  return true;\n}\n\nfunction isInterpolationEscapedId(identifierName, child) {\n  if (child && child.type === interpolationEscapedName && child.valuePath) {\n    return t.isIdentifier(child.valuePath.node, { name: identifierName });\n  }\n  return false;\n}\n"]}